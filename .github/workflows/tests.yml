name: Tests

on:
  pull_request:
    branches:
    - 'release/**'
    - 'develop'
  workflow_dispatch:

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_DVELOPMENT_IOS }}
  SSH_AUTH_SOCK: /tmp/ssh_agent.sock

jobs:
  test:
    name: Test
    runs-on: macos-15
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # When using Github runner images, the preferred way of setting the Ruby version is to use this official action instead of using rvm/rbenv
    - name: Install Ruby
      uses: ruby/setup-ruby@a2bbe5b1b236842c1cb7dd11e8e3b51e0a616acc  # v1.202.0

    - name: Authorize SSH session
      env:
        SSH_KEY: ${{ secrets.IOS_DEPENDENCIES_READ_ONLY_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan github.com > ~/.ssh/known_hosts
        echo "${SSH_KEY}" > ~/.ssh/ios_dependencies_ssh_key
        chmod 600 ~/.ssh/ios_dependencies_ssh_key
        ssh-agent -a "${SSH_AUTH_SOCK}" > /dev/null || true
        ssh-add ~/.ssh/ios_dependencies_ssh_key

    - name: Bundle Install
      run: bundle install

    - name: Tests
      run: bundle exec fastlane test

    - name: Build notification
      if: failure()
      uses: adamkdean/simple-slack-notify@master
      with:
        xcode-version: latest-stable
        channel: '#development-ios'
        text: 'Card SDK tests #${{ github.run_number }} failed'
        color: 'danger'
        fields: |
          [{ "title": "Action URL", "value": "${env.GITHUB_SERVER_URL}/${env.GITHUB_REPOSITORY}/actions/runs/${env.GITHUB_RUN_ID}"}]
